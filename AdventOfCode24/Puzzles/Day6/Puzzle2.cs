namespace AdventOfCode.Puzzles.Day6;

using System.Collections.Concurrent;
using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Jobs;
using NUnit.Framework;

[MemoryDiagnoser(false)]
[SimpleJob(RuntimeMoniker.Net90, baseline: true)]
public class Puzzle2
{
    [Test]
    [Benchmark]
    public void Solve()
    {
        var initialGrid = PuzzleInput
            .Split('\n', StringSplitOptions.RemoveEmptyEntries)
            .Select(x => x.ToCharArray())
            .ToArray();
        var initialPosition = initialGrid
            .SelectMany((row, x) => row.Select((cell, y) => (cell, x, y)))
            .First(t => t.cell == '^');
        var visitedPositions = DetectLoop(initialGrid, initialPosition).VisitedPositions
            .Select(x => (x.X, x.Y))
            .ToHashSet();
        var result = new ConcurrentBag<(int, int)>();

        visitedPositions.Remove((initialPosition.x, initialPosition.y));

        Parallel.ForEach(visitedPositions, (position, _) =>
        {
            var loop = DetectLoop(initialGrid, initialPosition, position).Loop;

            if (loop)
            {
                result.Add((position.X, position.Y));
            }
        });

        Console.WriteLine($"Found {result.Count} possible placements");
    }

    private static (bool Loop, HashSet<(int X, int Y, char)> VisitedPositions) DetectLoop(
        char[][] grid,
        (char direction, int x, int y) startingPosition,
        (int x, int y)? potentialObstacle = null
    )
    {
        bool ValidPosition(int x, int y) =>
            x >= 0 && x < grid.Length && y >= 0 && y < grid[0].Length;

        var directions = new Dictionary<char, (int, int, char)>
        {
            { '^', (-1, 0, '>') },
            { '>', (0, 1, 'v') },
            { 'v', (1, 0, '<') },
            { '<', (0, -1, '^') }
        };
        var (currentDirection, x, y) = startingPosition;
        var visited = new HashSet<(int, int, char)>();

        while (ValidPosition(x, y))
        {
            if (visited.Add((x, y, currentDirection)) is false)
            {
                return (true, visited);
            }

            var (dx, dy, nextDirection) = directions[currentDirection];
            var nextX = x + dx;
            var nextY = y + dy;

            if (
                ValidPosition(nextX, nextY)
                && (
                    grid[nextX][nextY] is '#'
                    || potentialObstacle.HasValue
                        && nextX == potentialObstacle.Value.x
                        && nextY == potentialObstacle.Value.y
                )
            )
            {
                currentDirection = nextDirection;
            }
            else
            {
                x = nextX;
                y = nextY;
            }
        }

        return (false, visited);
    }

    private const string PuzzleInput = """
        ...........#....................#......#.....................#.#...........#......................................................
        .....................................#....#.................#...............................#.....................................
        ..#..#.......#.............................................#.#.........................#......................#..............#....
        .........................#.....#...............#.................#................................................................
        .......#..........#........#.#............................................#....#.....................#..........##..#.............
        .........#.....................................................#..............................................................#...
        .....#..............................................................#................##.....#...........#.......#.........#.......
        .......#.........#......#...............#............................#.........#.....#.....#...#..................................
        .......#...............#...................#...............#............#.......................................................#.
        ........#.......................................................................##..#..............#...#..........................
        ..............#........#.......................#......#...............#..#......................#......#...#............#.........
        ................#................#...........................................#.....#................#..........#..................
        ..##....................#...........#......................#..................#.......#...........................................
        ..................................................................#..........#...................#................................
        ........................#.......#..........................#................................#.....................#...#.#.........
        ...............#........#...............#.##..#.#...............#...........#......................................#..............
        .#.........#.#...............................................................................#..........................#...#.....
        ..............................#.....#.............##..............#.##....................#......#.................#....#.........
        ..............#.............................#........#.....#..........................................#...........#...............
        ...................#.................#..............#....##..#......................#..............................#....#.#.......
        .............##.....................#..........#....................................#.....................#...#.#.................
        .........................#..........#.......#.................................#...................................................
        ............#.................#.................................................#.........##....................#.........#.....#.
        .#.........#.........................#..............#............#..#...........................##.........#......................
        ...........................#.....#...................#....#...........#.#.#...........#...................#.......................
        .................#..#......#..............................................................................#...................#...
        ...............................#..............#...#..#......##.#.........................#........#...........#...................
        ........#...............##.............................................................#..........................#...............
        .............#.............#.............#...................#...........#....................#...................................
        ##.......................................................................................#....#...........#....#...........#......
        .....................#.#.......................................#.....................................#.................#..........
        ......................#...................................................................#.....................#............#...#
        .........................#.#........................#.#................#....#....#.....#..........................................
        .....................#...#.......................................#.......#.............#...................#......................
        .............#...............#...............................................................................................#....
        ........................................................................................................#........#.........#......
        .................................##....................#....#..............#.....#.....#..#....#.........................#.#.....#
        .........................................................................#........#........#.........................#...#........
        #...................#..........#......................#..............................#.#........................#.................
        .#.....................................................................#..#.......#........................#......................
        .......................#..............#..............#..#..............................#..........................................
        ...................................................................................................#...................#..........
        ...............#............#....................................#.....................#....................#.....................
        ............#..#.#..........#.#.......#..........................#.................#.#..........#.......#.........................
        .......#....#.............................#..............................#..#........................#........#...................
        ........#.................#.....#.#..............................#........................#...................#..........#........
        ............................#........................#.........................................................#..................
        ....................................#.............##....................................................................#..#......
        ..................................................#................................................#..............#........#...##.
        ...........##.................#.........................#....................................................#...........#........
        ...........#.#..................#.......................#...#.......#................#.......##...................................
        ................................................#...........#........#.......................#.....................#....#.#.......
        ...............#........................................#............................#.....................................#......
        ........#...#.....#.......................................................#.#................................#.#..................
        .....#............#.#...............#.#.....#....................#.#...................#...................##.........#..........#
        ............#.................#....................................................#...........................................#..
        ................#..#.....#....................................#................#...#..............................................
        .....................................................................#...............#............................................
        ..................#...........#.....#...................#....#..............................................#.....................
        .#............#...................................#.........#.........................................#...........#...............
        #.......#..#...#.....#............................................................................................................
        ..#.........................................................##..............................#................................#....
        ..............................#..............#........................................................#....................#......
        #.........#.........#.............#..............#............................#..........#........................#..#............
        ....#...........#..........................##......#.............................#.....#........................#.................
        .....#.................................................................#..#.......................................................
        ..........................#.......#.......#..................#....................................................................
        ................#....................#..................#.........................................................................
        ..............................................#..........................#...........#.....#...........................#....#.#...
        .##...............#...#...........................................................................................................
        ..................#..#.......................#...#..#.#.................................#.........................#...........#...
        ..........................................................................#....................................#..................
        #...........#.............................##.....................#........#....#...#........#.....................#.....#.........
        .......#.............................#...^....#..................................#.........#......................................
        ........#..............................#................................#.....#....##.............................................
        .................#...........................#........................#..........#..........#.................#.#..........#.....#
        ..................................................................................................................#...............
        ..........#.........#........................#........................................................#........................#..
        ................................................................................................................#.................
        ....................#......................#....#.......#.....#...................................................................
        ................................#........................................................#.........................###............
        ......#..............#.#....................#............#.......................#.......................................#........
        .........................#....................................#..............#.......#............................................
        ..............#.................#........................................................#..#.....................................
        .....#.#........................#...........................................#..#.....#.................#................#......##.
        ................#.............#...................................................................................................
        #....................#..........#..............##...#........#..#.........................#............#......#..................#
        ...........#..#.......#.....................#..........................................................#........#.................
        ...............................................#................#...........#................................#....................
        .............#.......#.................#........#.............................................#...........#.......................
        ....................#.......#.....#.......................#.................#.............#.........................#.............
        .#..............#.................................................................................................................
        ..#.#......................................#.................#.........#...................................#.#....................
        ......#..............................#........#.#..................#................#.................................#...........
        ..............#........................................#..........................................................................
        .#...........#.........#...........#...................#................#..................................#............#..#......
        .........#....#...................#..#.................................................................#....#.....................
        ..........#...........................#.....................................#...............#.......#...#.........................
        ...........#..................................#............................................................##................#....
        .......................#..#.......................................................................................................
        ...............................................#......................#.#.#.............#..#........#...........................#.
        ..#.................................................#..............................#.....................................#........
        ..........#..#..........#...................#......................................##......#.......#........#.....#...............
        .#.#...............................................##...#................#..............#.....#...................................
        ....................#..#...............................#..#.......#....................#....#.....................#.....#.#.......
        #...................#...........#...................................................#...........................#..##.........###.
        .............#.........#......#..........................#.................#......##................#...............#...#.........
        ........#.....................................................................................#...................................
        ..#...........#...................................#...................#............................#.........#.................#..
        .................................................................................#................................................
        .#........#.................#......................................#.....#...........#................#...........................
        #...........................#..............................#....#............................................................#....
        #..........#.............................................#..........#.......................................................#.....
        .........#...#...#...#............................................................#....#..........#.......................#.......
        .........................#.........................#........#............#..............#.....##.........................#...#....
        ...............................#...........#..............................................#......................#......#.........
        ......................#........................#..#.....................#...............................#........................#
        ......#...##..............................................................................................................#.......
        ............#.............#.#...............................................#.........#..........................#...........#....
        .......................................#............#...............................................#.............................
        ....#........#.............................#...............#.#................................................#...................
        .........#.#........................#.....#...##...#.........###............#.#.........#......#.........#................#.....#.
        ...........#....................#......................##...............#.......................................................#.
        #......................................................#.................##....................................#........#.....#...
        ..#..........................##.................#...........................................#.....................................
        .......................................#............#......#...#.........#......##......................................#.........
        .#.......#.........................................##..............................................#.#...................#........
        .................#.........#..........................##............................#..#.....#....................................
        .....#....................................#......................................#.......................#...........#..#..#......
        .......#......#.........#.....#........#......#.................#...........#............#..................#....#...........#....
        """;
}
